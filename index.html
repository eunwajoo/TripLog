<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TripLog - ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡</title>

<!-- í°íŠ¸ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet & Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
:root{
  --ka-sky:#9ad7f0;   /* í•˜ëŠ˜ìƒ‰ */
  --ka-blue:#0e6eb8;  /* ëŒ€í•œí•­ê³µ ëŠë‚Œ ë¸”ë£¨ */
  --ink:#183046;
  --card:#ffffff;
  --glass: rgba(255,255,255,.92);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Noto Sans KR",system-ui,-apple-system,sans-serif;color:var(--ink);background:#f3f9ff}

/* ê³µí†µ ë²„íŠ¼ */
.btn{
  padding:.8rem 1rem;border-radius:12px;border:1px solid #b9ddf4;
  background:linear-gradient(180deg,#f7fcff,#e7f5ff);color:var(--ka-blue);
  font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(14,110,184,.12)
}
.btn:active{transform:translateY(1px)}
.btnPrimary{background:var(--ka-blue);color:#fff;border:none}

/* í™”ë©´ ì»¨í…Œì´ë„ˆ */
#screen-preflight, #screen-map{height:100%;display:none}
#screen-preflight.active, #screen-map.active{display:block}

/* ìƒë‹¨ í—¤ë” */
#header{
  position:relative;z-index:5;padding:10px 16px;background:linear-gradient(135deg,var(--ka-sky),#dff3fb);
  border-bottom:1px solid #d3ecfa;box-shadow:0 6px 18px rgba(14,110,184,.18)
}
#title{display:flex;gap:10px;align-items:center}
#logoBadge{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid #e6f3fb;box-shadow:0 3px 10px rgba(0,0,0,.06);font-size:20px}
#title h1{margin:0;font-size:18px;color:var(--ka-blue);line-height:1}
#title p{margin:2px 0 0;font-size:12px;opacity:.8}

/* ì¶œêµ­ ì¤€ë¹„ ë ˆì´ì•„ì›ƒ */
#prewrap{padding:14px;display:grid;gap:14px;grid-template-columns:1fr;max-width:1100px;margin:0 auto}
@media(min-width:920px){ #prewrap{grid-template-columns:1.4fr .9fr} }

/* ë³´ë”©íŒ¨ìŠ¤ ì¹´ë“œ */
.boarding{
  background:#fff;border-radius:18px;overflow:hidden;border:1px solid #e3eef8;
  box-shadow:0 12px 28px rgba(0,0,0,.08)
}
.bp-top{background:#2a3f70;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
.bp-top .title{font-weight:700;letter-spacing:.5px}
.bp-body{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px}
.bp-field{background:#f7fbff;border:1px dashed #cfe3f7;border-radius:12px;padding:10px}
.bp-label{font-size:11px;opacity:.7}
.bp-value{font-size:15px;font-weight:700}
.bp-input{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #cfe7f7}
.bp-row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.small{font-size:12px;opacity:.75}

/* ì—¬ê¶Œ ì¹´ë“œ */
.passport{
  position:relative;min-height:320px;background:#0b3b2e; /* ë”¥ ê·¸ë¦° */
  color:#d9c78f;border-radius:18px;padding:18px;border:1px solid #d3c8a1;
  box-shadow:0 12px 28px rgba(0,0,0,.1);
  background-image: radial-gradient(ellipse at 30% 10%, rgba(255,255,255,.08), transparent 60%),
                    radial-gradient(ellipse at 80% 80%, rgba(255,255,255,.06), transparent 60%);
}
.passport h3{margin:0 0 8px;font-weight:700;letter-spacing:.5px}
.passport .ko{font-weight:700}
.passport .en{font-size:12px;opacity:.9}
.passport .nameBox{
  margin-top:14px;background:#123e32;border:1px solid #cdbf8e;border-radius:10px;padding:12px;color:#fff
}
.passport .nameBox label{font-size:12px;opacity:.9}
.passport input{
  width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #cdbf8e;background:#0d3126;color:#fff
}
.passport .badge{
  position:absolute;right:14px;top:14px;background:#18304633;color:#fff;border:1px solid #cdbf8e;
  padding:6px 10px;border-radius:999px;font-size:12px
}

/* ì¶œêµ­ ë²„íŠ¼ */
#departWrap{display:flex;justify-content:center;padding:10px}
#departBtn{min-width:220px}

/* ì§€ë„ í™”ë©´ */
#controls{
  position:absolute;z-index:1000;left:50%;transform:translateX(-50%);
  top:74px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:960px
}
.ticket{
  display:flex;gap:10px;align-items:center;padding:12px;background:var(--glass);
  border:1px dashed #cde8f7;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);backdrop-filter:blur(6px)
}
.ticket input{
  width:220px;max-width:60vw;padding:10px 12px;border-radius:12px;border:1px solid #cfe7f7;outline:none;font-size:14px;background:#fff
}
#map{height:100%;width:100%}
.leaflet-top.leaflet-left{top:130px}

/* ì¶”ì–µ ë¦¬ìŠ¤íŠ¸ */
#memoryList{
  position:absolute;z-index:1000;left:12px;bottom:12px;width:min(320px,90vw);max-height:40vh;overflow:auto;
  background:var(--glass);border:1px solid #d6eefd;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:10px 12px
}
#memoryList h3{margin:4px 0 8px;font-size:14px;color:var(--ka-blue)}
.mem{display:flex;gap:8px;align-items:center;padding:6px;border-radius:10px;cursor:pointer}
.mem:hover{background:#f2f9ff}

/* ëª¨ë‹¬ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:2000;padding:16px}
.modalCard{width:min(460px,94vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 22px 48px rgba(0,0,0,.22);border:1px solid #e8f2fb}
.modalCard h3{margin:0 0 8px;color:var(--ka-blue)}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body>

<!-- ê³µí†µ í—¤ë” -->
<div id="header">
  <div id="title">
    <div id="logoBadge">âœˆï¸</div>
    <div>
      <h1>TripLog</h1>
      <p>ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡</p>
    </div>
  </div>
</div>

<!-- â”€â”€ ì¶œêµ­ ì¤€ë¹„ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section id="screen-preflight" class="active" aria-label="ì¶œêµ­ ì¤€ë¹„">
  <div id="prewrap">
    <!-- ì¢Œ: ë³´ë”©íŒ¨ìŠ¤ -->
    <div class="boarding">
      <div class="bp-top">
        <div class="title">BOARDING PASS</div>
        <div class="small">Carrier Â· TripLog Air</div>
      </div>
      <div class="bp-body">
        <div class="bp-field">
          <div class="bp-label">From</div>
          <div class="bp-value" id="bp-from">ICN Â· ì¸ì²œêµ­ì œê³µí•­</div>
        </div>
        <div class="bp-field">
          <div class="bp-label">To (ë‚˜ë¼)</div>
          <input id="countryInput" class="bp-input" list="countryList" placeholder="ì˜ˆ: ì¼ë³¸, í”„ë‘ìŠ¤, ë² íŠ¸ë‚¨">
          <datalist id="countryList"></datalist>
        </div>

        <div class="bp-field">
          <div class="bp-label">Region (ì§€ì—­)</div>
          <input id="regionInput" class="bp-input" placeholder="ì˜ˆ: ì˜¤ì‚¬ì¹´, íŒŒë¦¬, ë‹¤ë‚­">
        </div>
        <div class="bp-field">
          <div class="bp-label">Date Â· Time</div>
          <div class="bp-value" id="bp-dt"></div>
        </div>

        <div class="bp-row small">
          ì…ë ¥í•œ êµ­ê°€ëŠ” ë„ì°© ê³µí•­ì„ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”(ì¼ë³¸/ë² íŠ¸ë‚¨ì€ ë³µìˆ˜ ê³µí•­).
        </div>
      </div>
    </div>

    <!-- ìš°: ì—¬ê¶Œ -->
    <div class="passport">
      <div class="badge">REPUBLIC OF KOREA</div>
      <h3 class="ko">ëŒ€í•œë¯¼êµ­</h3>
      <div class="en">REPUBLIC OF KOREA Â· PASSPORT</div>

      <div class="nameBox">
        <label>ì—¬ê¶Œ ì˜ë¬¸ëª… (Passenger Name)</label>
        <input id="passengerName" placeholder="ì˜ˆ: EUNCHAN KIM">
      </div>

      <div style="margin-top:14px;font-size:12px;opacity:.85">
        ì´ë¦„ê³¼ ëª©ì ì§€ë¥¼ ì…ë ¥í•œ ë’¤, ì•„ë˜ <b>ì¶œêµ­</b>ì„ ëˆ„ë¥´ë©´ ì—¬í–‰ì´ ì‹œì‘ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div id="departWrap">
    <button id="departBtn" class="btn btnPrimary">âœˆï¸ ì¶œêµ­</button>
  </div>
</section>

<!-- â”€â”€ ì§€ë„ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section id="screen-map" aria-label="ì—¬í–‰ ì§€ë„">
  <!-- ìƒë‹¨ ê²€ìƒ‰(ë„¤ë¹„/í‹°ì¼“ ëŠë‚Œ) -->
  <div id="controls">
    <div class="ticket">
      ğŸŒ <input id="countryInput2" type="text" placeholder="ë‚˜ë¼ ë‹¤ì‹œ ì…ë ¥/ë³€ê²½" list="countryList">
      <button class="btn" id="btnFly">âœˆï¸ ì¶œë°œ</button>
    </div>
    <div class="ticket">
      ğŸ—ºï¸ <input id="regionInput2" type="text" placeholder="ì§€ì—­ ì…ë ¥ (ì˜ˆ: ì˜¤ì‚¬ì¹´, íŒŒë¦¬, ë‹¤ë‚­)">
      <button class="btn" id="btnDrive">ğŸš• ì´ë™</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- ì¶”ì–µ ë¦¬ìŠ¤íŠ¸ -->
  <div id="memoryList" aria-live="polite">
    <h3>ğŸ“¸ ì €ì¥ëœ ì¶”ì–µ</h3>
    <div id="memWrap"></div>
  </div>
</section>

<!-- ê³µí•­ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="airportModal">
  <div class="modalCard">
    <h3>ë„ì°© ê³µí•­ ì„ íƒ</h3>
    <div id="airportOptions"></div>
    <div class="modalActions">
      <button class="btn" id="airportCancel">ì·¨ì†Œ</button>
      <button class="btn btnPrimary" id="airportOk">ë¹„í–‰ ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- ì¶”ì–µ ì €ì¥ ëª¨ë‹¬ -->
<div class="modal" id="memoryModal">
  <div class="modalCard">
    <h3>ì¶”ì–µ ì €ì¥</h3>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <input type="text" id="memoryTitle" placeholder="ì œëª© (ì„ íƒ)">
    </div>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <textarea id="memoryText" rows="4" style="width:100%;" placeholder="ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”"></textarea>
    </div>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <input type="file" id="memoryImage" accept="image/*">
    </div>
    <div class="modalActions">
      <button class="btn" id="memCancel">ë‹«ê¸°</button>
      <button class="btn btnPrimary" id="memSave">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ========== ê³µí†µ ìƒíƒœ/ìœ í‹¸ ========== */
let map, geocoder, planeMarker, carMarker, currentAirportLatLng=null, clickLatLng=null;
const memoryLayer = L.layerGroup(); const pathsLayer = L.layerGroup();
const toRad = d=>d*Math.PI/180, toDeg = r=>r*180/Math.PI;
const easeInOut = t => t<.5 ? 2*t*t : -1+(4-2*t)*t;
const bearing = (a,b)=>{const Ï†1=toRad(a.lat),Ï†2=toRad(b.lat),Î”Î»=toRad(b.lng-a.lng);
  const y=Math.sin(Î”Î»)*Math.cos(Ï†2),x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  return (toDeg(Math.atan2(y,x))+360)%360;};
function emojiIcon(html){return L.divIcon({className:'emoji-icon',html:`<span class="emoji-rotate" style="font-size:28px;transform-origin:center;">${html}</span>`,iconSize:[36,36],iconAnchor:[18,18]});}
function setEmojiRotation(marker,deg){const el=marker?._icon?.querySelector('.emoji-rotate'); if(el){el.style.transform=`rotate(${deg}deg)`;}}
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none';}
function fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
function nowKR(){const d=new Date();return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
document.getElementById('bp-dt').textContent = nowKR();

/* ========== ê³µí•­ DB (OECD + ë™ë‚¨ì•„ + ëŸ¬ì‹œì•„, ëŒ€í‘œ 1ê°œ / ì¼ë³¸Â·ë² íŠ¸ë‚¨ ë‹¤ì¤‘) ========== */
const airports = {
  "ëŒ€í•œë¯¼êµ­":[{code:"ICN",name:"ì¸ì²œêµ­ì œê³µí•­",lat:37.4602,lng:126.4407}],
  "ì¼ë³¸":[
    {code:"NRT",name:"ë„ì¿„ ë‚˜ë¦¬íƒ€ êµ­ì œê³µí•­",lat:35.7719,lng:140.3929},
    {code:"HND",name:"ë„ì¿„ í•˜ë„¤ë‹¤ êµ­ì œê³µí•­",lat:35.5494,lng:139.7798},
    {code:"KIX",name:"ì˜¤ì‚¬ì¹´ ê°„ì‚¬ì´ êµ­ì œê³µí•­",lat:34.4347,lng:135.2442},
    {code:"FUK",name:"í›„ì¿ ì˜¤ì¹´ ê³µí•­",lat:33.5859,lng:130.4500},
    {code:"CTS",name:"ì‚¿í¬ë¡œ ì‹ ì¹˜í† ì„¸",lat:42.7752,lng:141.6923}
  ],
  "ë² íŠ¸ë‚¨":[
    {code:"HAN",name:"í•˜ë…¸ì´ ë…¸ì´ë°”ì´",lat:21.2210,lng:105.8072},
    {code:"SGN",name:"í˜¸ì°Œë¯¼ ë–¤ì„ ë…“",lat:10.8188,lng:106.6519},
    {code:"DAD",name:"ë‹¤ë‚­ êµ­ì œê³µí•­",lat:16.0439,lng:108.1994},
    {code:"CXR",name:"ë‚˜íŠ¸ë‘ ê¹œë¼ì¸",lat:11.9981,lng:109.2194},
    {code:"PQC",name:"í‘¸ê¾¸ì˜¥",lat:10.1698,lng:103.9931}
  ],
  /* OECD */
  "ë¯¸êµ­":[{code:"JFK",name:"ë‰´ìš• JFK",lat:40.6413,lng:-73.7781}],
  "ìºë‚˜ë‹¤":[{code:"YYZ",name:"í† ë¡ í†  í”¼ì–´ìŠ¨",lat:43.6777,lng:-79.6248}],
  "ë©•ì‹œì½”":[{code:"MEX",name:"ë©•ì‹œì½”ì‹œí‹° AICM",lat:19.4361,lng:-99.0719}],
  "ì¹ ë ˆ":[{code:"SCL",name:"ì‚°í‹°ì•„ê³  ì•„ë¥´íˆ¬ë¡œ ë©”ë¦¬ë…¸",lat:-33.3929,lng:-70.7858}],
  "ì½œë¡¬ë¹„ì•„":[{code:"BOG",name:"ë³´ê³ íƒ€ ì—˜ë„ë¼ë„",lat:4.7016,lng:-74.1469}],
  "ì½”ìŠ¤íƒ€ë¦¬ì¹´":[{code:"SJO",name:"ì‚°í˜¸ì„¸ SJO",lat:9.9939,lng:-84.2088}],
  "í˜¸ì£¼":[{code:"SYD",name:"ì‹œë“œë‹ˆ",lat:-33.9399,lng:151.1753}],
  "ë‰´ì§ˆëœë“œ":[{code:"AKL",name:"ì˜¤í´ëœë“œ",lat:-37.0082,lng:174.7850}],
  "ì˜êµ­":[{code:"LHR",name:"ëŸ°ë˜ íˆë“œë¡œ",lat:51.47,lng:-0.4543}],
  "ì•„ì¼ëœë“œ":[{code:"DUB",name:"ë”ë¸”ë¦°",lat:53.4273,lng:-6.2436}],
  "í”„ë‘ìŠ¤":[{code:"CDG",name:"íŒŒë¦¬ ìƒ¤ë¥¼ë“œê³¨",lat:49.0097,lng:2.5479}],
  "ë…ì¼":[{code:"FRA",name:"í”„ë‘í¬í‘¸ë¥´íŠ¸",lat:50.0379,lng:8.5622}],
  "ì´íƒˆë¦¬ì•„":[{code:"FCO",name:"ë¡œë§ˆ í”¼ìš°ë¯¸ì¹˜ë…¸",lat:41.8003,lng:12.2389}],
  "ìŠ¤í˜ì¸":[{code:"MAD",name:"ë§ˆë“œë¦¬ë“œ ë°”ë¼í•˜ìŠ¤",lat:40.4983,lng:-3.5676}],
  "í¬ë¥´íˆ¬ê°ˆ":[{code:"LIS",name:"ë¦¬ìŠ¤ë³¸",lat:38.7742,lng:-9.1342}],
  "ë„¤ëœë€ë“œ":[{code:"AMS",name:"ì•”ìŠ¤í…Œë¥´ë‹´ ìŠ¤í‚¤í´",lat:52.3105,lng:4.7683}],
  "ë²¨ê¸°ì—":[{code:"BRU",name:"ë¸Œë¤¼ì…€",lat:50.9010,lng:4.4844}],
  "ë£©ì…ˆë¶€ë¥´í¬":[{code:"LUX",name:"ë£©ì…ˆë¶€ë¥´í¬",lat:49.6266,lng:6.2115}],
  "ìŠ¤ìœ„ìŠ¤":[{code:"ZRH",name:"ì·¨ë¦¬íˆ",lat:47.4581,lng:8.5555}],
  "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„":[{code:"VIE",name:"ë¹„ì—”ë‚˜",lat:48.1103,lng:16.5697}],
  "ë´ë§ˆí¬":[{code:"CPH",name:"ì½”íœí•˜ê²",lat:55.6180,lng:12.6508}],
  "ë…¸ë¥´ì›¨ì´":[{code:"OSL",name:"ì˜¤ìŠ¬ë¡œ ê°€ë¥´ë°ë¥´ëª¨ì—”",lat:60.1976,lng:11.1004}],
  "ìŠ¤ì›¨ë´":[{code:"ARN",name:"ìŠ¤í†¡í™€ë¦„ ì•Œë€ë‹¤",lat:59.6498,lng:17.9238}],
  "í•€ë€ë“œ":[{code:"HEL",name:"í—¬ì‹±í‚¤ ë°˜íƒ€",lat:60.3172,lng:24.9633}],
  "ì•„ì´ìŠ¬ë€ë“œ":[{code:"KEF",name:"ì¼€í”Œë¼ë¹„í¬",lat:63.9978,lng:-22.6243}],
  "í´ë€ë“œ":[{code:"WAW",name:"ë°”ë¥´ìƒ¤ë°” ì‡¼íŒ½",lat:52.1657,lng:20.9671}],
  "ì²´ì½”":[{code:"PRG",name:"í”„ë¼í•˜",lat:50.1062,lng:14.2669}],
  "ìŠ¬ë¡œë°”í‚¤ì•„":[{code:"BTS",name:"ë¸Œë¼í‹°ìŠ¬ë¼ë°”",lat:48.1698,lng:17.1996}],
  "í—ê°€ë¦¬":[{code:"BUD",name:"ë¶€ë‹¤í˜ìŠ¤íŠ¸",lat:47.4369,lng:19.2556}],
  "ìŠ¬ë¡œë² ë‹ˆì•„":[{code:"LJU",name:"ë¥˜ë¸”ë´ë‚˜",lat:46.2237,lng:14.4576}],
  "í¬ë¡œì•„í‹°ì•„":[{code:"ZAG",name:"ìê·¸ë ˆë¸Œ",lat:45.7429,lng:16.0688}],
  "ê·¸ë¦¬ìŠ¤":[{code:"ATH",name:"ì•„í…Œë„¤",lat:37.9364,lng:23.9475}],
  "í„°í‚¤":[{code:"IST",name:"ì´ìŠ¤íƒ„ë¶ˆ",lat:41.2753,lng:28.7519}],
  "ì´ìŠ¤ë¼ì—˜":[{code:"TLV",name:"í…”ì•„ë¹„ë¸Œ ë²¤êµ¬ë¦¬ì˜¨",lat:32.0005,lng:34.8707}],
  "í¬ëŸ¼êµ­ê°€":[], /* placeholder */
  "ë¼íŠ¸ë¹„ì•„":[{code:"RIX",name:"ë¦¬ê°€",lat:56.9221,lng:23.9798}],
  "ë¦¬íˆ¬ì•„ë‹ˆì•„":[{code:"VNO",name:"ë¹Œë‰´ìŠ¤",lat:54.6340,lng:25.2857}],
  "ì—ìŠ¤í† ë‹ˆì•„":[{code:"TLL",name:"íƒˆë¦°",lat:59.4133,lng:24.8328}],
  "ìŠ¤ì½”í‹€ëœë“œ": [{code:"EDI",name:"ì—ë“ ë²„ëŸ¬",lat:55.9503,lng:-3.3725}], /* í¸ì˜ìƒ */
  /* ë™ë‚¨ì•„(ASEAN) */
  "ì‹±ê°€í¬ë¥´":[{code:"SIN",name:"ì°½ì´",lat:1.3644,lng:103.9915}],
  "ë§ë ˆì´ì‹œì•„":[{code:"KUL",name:"ì¿ ì•Œë¼ë£¸í‘¸ë¥´",lat:2.7456,lng:101.709}],
  "ì¸ë„ë„¤ì‹œì•„":[{code:"CGK",name:"ìì¹´ë¥´íƒ€ ìˆ˜ì¹´ë¥´ë…¸-í•˜íƒ€",lat:-6.1256,lng:106.6559}],
  "íƒœêµ­":[{code:"BKK",name:"ë°©ì½• ìˆ˜ì™„ë‚˜í’ˆ",lat:13.6900,lng:100.7501}],
  "í•„ë¦¬í•€":[{code:"MNL",name:"ë§ˆë‹ë¼ NAIA",lat:14.5086,lng:121.0198}],
  "ìº„ë³´ë””ì•„":[{code:"PNH",name:"í”„ë†ˆíœ",lat:11.5466,lng:104.8439}],
  "ë¼ì˜¤ìŠ¤":[{code:"VTE",name:"ë¹„ì—”í‹°ì•ˆ",lat:17.9883,lng:102.5630}],
  "ë¸Œë£¨ë‚˜ì´":[{code:"BWN",name:"ë°˜ë‹¤ë¥´ìŠ¤ë¦¬ë¸Œê°€ì™„",lat:4.9442,lng:114.9283}],
  "ë¯¸ì–€ë§ˆ":[{code:"RGN",name:"ì–‘ê³¤",lat:16.9073,lng:96.1332}],
  /* ëŸ¬ì‹œì•„ */
  "ëŸ¬ì‹œì•„":[{code:"SVO",name:"ëª¨ìŠ¤í¬ë°” ì…°ë ˆë©”í‹°ì˜ˆë³´",lat:55.9726,lng:37.4146}]
};
const ICN = airports["ëŒ€í•œë¯¼êµ­"][0];

/* datalist ì±„ìš°ê¸° */
(function fillCountries(){
  const dl = document.getElementById('countryList');
  const names = Object.keys(airports).filter(k=>airports[k].length);
  names.sort().forEach(n=>{
    const o=document.createElement('option');o.value=n;dl.appendChild(o);
  });
})();

/* ========== ì¶œêµ­ ë²„íŠ¼ â†’ ì§€ë„í™”ë©´ ì „í™˜ & ë¹„í–‰ ========== */
document.getElementById('departBtn').addEventListener('click', ()=>{
  const name = document.getElementById('passengerName').value.trim();
  const country = document.getElementById('countryInput').value.trim();
  const region = document.getElementById('regionInput').value.trim();
  if(!name){alert('ì—¬ê¶Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  if(!country){alert('ë‚˜ë¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}

  // ì§€ë„ í™”ë©´ ì¤€ë¹„
  initMapIfNeeded();
  document.getElementById('screen-preflight').classList.remove('active');
  document.getElementById('screen-map').classList.add('active');

  // ìƒë‹¨ ì…ë ¥ì—ë„ ê°’ ë°˜ì˜
  document.getElementById('countryInput2').value = country;
  document.getElementById('regionInput2').value = region;

  // ë¹„í–‰ ì‹œì‘
  flyToCountry(country, region);
});

/* ========== ì§€ë„/ì§€ì˜¤ì½”ë”/ë©”ëª¨ UI ì´ˆê¸°í™” ========== */
function initMapIfNeeded(){
  if(map) return;
  map = L.map('map', { zoomControl:true }).setView([37.5665,126.9780], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  geocoder = L.Control.Geocoder.nominatim();
  L.Control.geocoder({ placeholder: 'ì¥ì†Œ ê²€ìƒ‰(ë³´ì¡°ìš©)' }).addTo(map);
  memoryLayer.addTo(map); pathsLayer.addTo(map);

  // ì§€ë„ í´ë¦­ â†’ ì¶”ì–µ ì €ì¥
  map.on('click', (e)=>{ clickLatLng=e.latlng; openModal('memoryModal'); });

  // ë²„íŠ¼ ë°”ì¸ë”©
  document.getElementById('btnFly').onclick = ()=> flyToCountry(document.getElementById('countryInput2').value.trim());
  document.getElementById('btnDrive').onclick = ()=> driveToRegion(document.getElementById('regionInput2').value.trim());

  // ë©”ëª¨ ëª¨ë‹¬
  document.getElementById('memCancel').onclick = ()=> closeModal('memoryModal');
  document.getElementById('memSave').onclick = saveMemory;

  renderMemories();
  window.addEventListener('resize', ()=> map.invalidateSize());
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){closeModal('airportModal');closeModal('memoryModal');} });
}

/* ========== ê³µí•­ ì„ íƒ / ë¹„í–‰ / íƒì‹œ ì´ë™ ========== */
const airportModal = document.getElementById('airportModal');
const airportOptions = document.getElementById('airportOptions');
document.getElementById('airportCancel').onclick = ()=> closeModal('airportModal');
document.getElementById('airportOk').onclick = ()=>{
  const idx = Number(document.querySelector('input[name="apSel"]:checked')?.value ?? 0);
  closeModal('airportModal');
  const ap = _pendingAirports[idx];
  doFly(ICN, ap);
};
let _pendingAirports = [];

function showAirportChoice(list){
  airportOptions.innerHTML = list.map((ap,i)=>`
    <label style="display:flex;gap:8px;align-items:center;margin:6px 0;">
      <input type="radio" name="apSel" value="${i}" ${i===0?'checked':''}/>
      <div><strong>${ap.name}</strong><div style="font-size:12px;opacity:.7">${ap.code} Â· ${ap.lat.toFixed(3)}, ${ap.lng.toFixed(3)}</div></div>
    </label>`).join('');
  _pendingAirports = list; openModal('airportModal');
}

async function flyToCountry(country, regionOpt){
  if(!country){alert('ë‚˜ë¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  // ë¯¸ë¦¬ ë“±ë¡ëœ ê³µí•­ì´ë©´: ì¼ë³¸/ë² íŠ¸ë‚¨ì€ ì„ íƒ, ë‚˜ë¨¸ì§€ëŠ” ì²« ë²ˆì§¸ ì‚¬ìš©
  if(airports[country]?.length){
    if(airports[country].length>1){ showAirportChoice(airports[country]); }
    else { doFly(ICN, airports[country][0]); }
    return;
  }
  // ë“±ë¡ì— ì—†ìœ¼ë©´ ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ì°¾ê¸°
  const target = await geocodeOne(`${country} êµ­ì œê³µí•­`) || await geocodeOne(`${country} airport`) || await geocodeOne(country);
  if(!target){ alert('í•´ë‹¹ êµ­ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.'); return; }
  doFly(ICN, {code:country.toUpperCase(), name:`${country} ë„ì°© ì§€ì `, lat:target.lat, lng:target.lng});
}

function geocodeOne(query){
  return new Promise(resolve=>{
    geocoder.geocode(query, results=>{
      if(results && results[0]){ const r=results[0]; resolve({lat:r.center.lat,lng:r.center.lng,name:r.name||query}); }
      else resolve(null);
    });
  });
}

function ensurePlane(){ if(!planeMarker){ planeMarker = L.marker([ICN.lat,ICN.lng],{icon:emojiIcon('âœˆï¸'),interactive:false}).addTo(map); } }
function ensureCar(){ if(!carMarker){ carMarker = L.marker([ICN.lat,ICN.lng],{icon:emojiIcon('ğŸš•'),interactive:false}).addTo(map); } }

function animateTravel({start,end,marker,duration=15000,trailColor="#0e6eb8",onDone}){
  pathsLayer.clearLayers();
  L.polyline([start,end],{color:trailColor,weight:3,opacity:.5,dashArray:"6 10"}).addTo(pathsLayer);
  const startTime=performance.now(), dir=bearing(start,end); setEmojiRotation(marker,dir);
  (function step(now){
    const t=Math.min((now-startTime)/duration,1), k=easeInOut(t);
    const lat=start.lat+(end.lat-start.lat)*k, lng=start.lng+(end.lng-start.lng)*k;
    marker.setLatLng([lat,lng]); setEmojiRotation(marker,dir);
    if(t<1) requestAnimationFrame(step); else onDone && onDone();
  })(startTime);
}

function doFly(fromAp, toAp){
  ensurePlane();
  map.setView([fromAp.lat,fromAp.lng],4,{animate:true});
  animateTravel({
    start:L.latLng(fromAp.lat,fromAp.lng),
    end:L.latLng(toAp.lat,toAp.lng),
    marker:planeMarker,
    duration:15000,
    trailColor:"#0e6eb8",
    onDone:()=>{
      currentAirportLatLng = L.latLng(toAp.lat,toAp.lng);
      map.flyTo(currentAirportLatLng,7,{duration:1.2});
      L.circleMarker(currentAirportLatLng,{radius:6,color:'#0e6eb8',fillColor:'#0e6eb8',fillOpacity:.9})
        .addTo(pathsLayer).bindTooltip(`${toAp.name}`,{direction:'top'});
    }
  });
}

async function driveToRegion(region){
  region = region?.trim() || document.getElementById('regionInput2').value.trim();
  if(!region){alert('ì§€ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  if(!currentAirportLatLng){alert('ë¨¼ì € ë‚˜ë¼ë¡œ ë¹„í–‰í•´ ê³µí•­ì— ë„ì°©í•´ì•¼ í•´ìš”.');return;}
  const r = await geocodeOne(region);
  if(!r){alert('ì§€ì—­ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.');return;}
  ensureCar(); carMarker.setLatLng(currentAirportLatLng);
  animateTravel({
    start:currentAirportLatLng,
    end:L.latLng(r.lat,r.lng),
    marker:carMarker,
    duration:9000,
    trailColor:"#26a269",
    onDone:()=>{
      currentAirportLatLng = L.latLng(r.lat,r.lng);
      map.flyTo(currentAirportLatLng,13,{duration:1.0});
      L.marker(currentAirportLatLng).addTo(pathsLayer).bindPopup(`ë„ì°©: ${region}`).openPopup();
    }
  });
}

/* ========== ì¶”ì–µ ì €ì¥(LocalStorage) ========== */
function loadMemories(){ try{ return JSON.parse(localStorage.getItem('triplog_memories')||'[]'); }catch(e){ return []; } }
function renderMemories(){
  const list = loadMemories(); const wrap = document.getElementById('memWrap');
  wrap.innerHTML=''; memoryLayer.clearLayers();
  list.forEach(m=>{ addMemoryToUI(m); addMemoryMarker(m); });
}
function addMemoryToUI(m){
  const wrap=document.getElementById('memWrap'), div=document.createElement('div'); div.className='mem';
  div.innerHTML = `
    <div style="width:44px;height:44px;border-radius:8px;background:#e9f5ff;display:grid;place-items:center;">ğŸ“</div>
    <div style="flex:1;">
      <div style="font-weight:700;font-size:13px;">${m.title||'ì œëª© ì—†ìŒ'}</div>
      <div style="font-size:12px;opacity:.75;">${m.text?m.text.slice(0,40):'ë©”ëª¨ ì—†ìŒ'}</div>
    </div>`;
  div.onclick = ()=>{
    const pos=L.latLng(m.lat,m.lng);
    map.flyTo(pos,14,{duration:.8});
    L.marker(pos).addTo(pathsLayer).bindPopup(`<strong>${m.title||'ì œëª© ì—†ìŒ'}</strong><br>${m.text||''}${m.img?`<br><img src="${m.img}" style="width:180px;border-radius:8px;margin-top:6px;">`:''}`).openPopup();
  };
  wrap.prepend(div);
}
function addMemoryMarker(m){
  const mk=L.marker([m.lat,m.lng]).addTo(memoryLayer);
  mk.bindPopup(`<strong>${m.title||'ì œëª© ì—†ìŒ'}</strong><br>${m.text||''}${m.img?`<br><img src="${m.img}" style="width:180px;border-radius:8px;margin-top:6px;">`:''}`);
}
async function saveMemory(){
  const title=document.getElementById('memoryTitle').value.trim();
  const text=document.getElementById('memoryText').value.trim();
  const file=document.getElementById('memoryImage').files[0];
  let img=""; if(file){ img=await fileToDataURL(file); }
  const mem={id:'mem_'+Date.now(),lat:clickLatLng.lat,lng:clickLatLng.lng,title,text,img,createdAt:new Date().toISOString()};
  const all=loadMemories(); all.push(mem); localStorage.setItem('triplog_memories',JSON.stringify(all));
  addMemoryToUI(mem); addMemoryMarker(mem); closeModal('memoryModal');
  document.getElementById('memoryTitle').value=''; document.getElementById('memoryText').value=''; document.getElementById('memoryImage').value='';
}

/* ì´ˆê¸° ê°’ í‘œì‹œ */
document.getElementById('bp-from').textContent = `ICN Â· ì¸ì²œêµ­ì œê³µí•­`;
</script>
</body>
</html>
