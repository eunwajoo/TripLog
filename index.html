<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TripLog — 우리의 여행 기록</title>

<!-- Leaflet + Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --ka-sky:#9ad7f0; --ka-blue:#0e6eb8; --ink:#183046;
  --card:#ffffff; --glass:rgba(255,255,255,.92); --gold:#cdbf8e;
  --accent:#ff7a00; --accent2:#ffd21f; --ok:#1aa36a;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#f3f9ff;color:var(--ink);font-family:"Noto Sans KR",-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Arial,sans-serif}
.btn{padding:.85rem 1rem;border-radius:12px;border:1px solid #b9ddf4;background:linear-gradient(180deg,#f7fcff,#e7f5ff);color:var(--ka-blue);font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(14,110,184,.12)}
.btnPrimary{background:var(--ka-blue);color:#fff;border:none}
.btnWarn{background:var(--accent);color:#fff;border:none}
.btnGhost{background:#fff;color:var(--ink);border:1px solid #eaeef5}
.btn:disabled{opacity:.5;cursor:not-allowed}
#screen-preflight,#screen-map{height:100%;display:none}
#screen-preflight.active,#screen-map.active{display:block}
#header{position:relative;z-index:5;padding:10px 16px;background:linear-gradient(135deg,var(--ka-sky),#dff3fb);border-bottom:1px solid #d3ecfa;box-shadow:0 6px 18px rgba(14,110,184,.18);display:flex;align-items:center;justify-content:space-between}
#title{display:flex;gap:10px;align-items:center}
#logoBadge{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid #e6f3fb;box-shadow:0 3px 10px rgba(0,0,0,.06);font-size:18px}
#title h1{margin:0;font-size:18px;color:var(--ka-blue);line-height:1}
#title p{margin:2px 0 0;font-size:12px;opacity:.8}
#userChip{display:flex;gap:8px;align-items:center;background:#ffffffaa;border:1px solid #e6eef8;border-radius:999px;padding:8px 12px;backdrop-filter:blur(6px);box-shadow:0 3px 10px rgba(0,0,0,.06);font-size:13px}
.badge{padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid #e6eef8;background:#fff}
.badgeRank{background:#e9f3ff;border-color:#cfe3ff;color:#0e6eb8}
.badgePhoto{background:#fff7db;border-color:#ffe6a3;color:#8a6a00}

#prewrap{padding:14px;display:grid;gap:14px;grid-template-columns:1fr;max-width:1200px;margin:0 auto}
@media(min-width:980px){ #prewrap{grid-template-columns:1.4fr .9fr} }
.boarding{background:#fff;border-radius:18px;overflow:hidden;border:1px solid #e3eef8;box-shadow:0 12px 28px rgba(0,0,0,.08)}
.bp-top{background:#2a3f70;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
.bp-body{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px}
.bp-field{background:#f7fbff;border:1px dashed #cfe3f7;border-radius:12px;padding:10px}
.bp-label{font-size:11px;opacity:.7}
.bp-input{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #cfe7f7}
.bp-row{grid-column:1/-1}

.passport{position:relative;min-height:320px;background:#0b3b2e;color:#d9c78f;border-radius:18px;padding:18px;border:1px solid #d3c8a1;box-shadow:0 12px 28px rgba(0,0,0,.1)}
.passport .nameBox{margin-top:14px;background:#123e32;border:1px solid var(--gold);border-radius:10px;padding:12px;color:#fff}
.passport input{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid var(--gold);background:#0d3126;color:#fff}
.passport .badge{position:absolute;right:14px;top:14px;background:#18304633;color:#fff;border:1px solid var(--gold);padding:6px 10px;border-radius:999px;font-size:12px}

#controls{position:absolute;z-index:1000;left:50%;transform:translateX(-50%);top:74px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:1060px}
.ticket{display:flex;gap:10px;align-items:center;padding:12px;background:var(--glass);border:1px dashed #cde8f7;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);backdrop-filter:blur(6px)}
.ticket input{width:220px;max-width:60vw;padding:10px 12px;border-radius:12px;border:1px solid #cfe7f7;outline:none;font-size:14px;background:#fff}
#map{height:100%;width:100%}
.leaflet-top.leaflet-left{top:130px}

#memoryList{position:absolute;z-index:1000;left:12px;bottom:12px;width:min(340px,90vw);max-height:44vh;overflow:auto;background:var(--glass);border:1px solid #d6eefd;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:10px 12px}
#memoryList h3{margin:4px 0 8px;font-size:14px;color:var(--ka-blue)}
.mem{display:flex;gap:8px;align-items:center;padding:6px;border-radius:10px;cursor:pointer}
.mem:hover{background:#f2f9ff}

#quickActions{position:absolute;right:12px;bottom:12px;z-index:1200;display:grid;gap:8px}
.quickCard{background:var(--glass);border:1px solid #e6eef8;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:10px;display:grid;gap:8px}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:2000;padding:16px}
.modalCard{width:min(520px,94vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 22px 48px rgba(0,0,0,.22);border:1px solid #e8f2fb}
.modalCard h3{margin:0 0 8px;color:var(--ka-blue)}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

#achvTitle{font-size:26px;color:var(--ok);margin:6px 0 0;font-weight:800;text-align:center}
#achvBadge{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:999px;background:#eafff4;color:#0b6b45;border:1px solid #b9f1d7;font-weight:800}

#galleryModal .modalCard{width:min(720px,96vw)}
.galleryHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.galleryTitle{font-weight:800;color:#0e6eb8}
.galleryWrap{position:relative;overflow:hidden;border-radius:12px;border:1px solid #e6eef8;background:#000}
.galleryStage{display:flex;transition:transform .35s ease}
.galleryItem{min-width:100%;display:flex;align-items:center;justify-content:center;background:#000}
.galleryItem img{max-width:100%;max-height:54vh;display:block}
.galleryNav{display:flex;justify-content:space-between;margin-top:8px;gap:8px}
.galleryMeta{margin-top:8px;font-size:13px}
.galleryMeta .by{opacity:.8}

.icon-rot{display:inline-block;transform-origin:center;will-change:transform}
@media(max-width:540px){ .bp-body{grid-template-columns:1fr} #controls{top:66px} }
</style>
</head>
<body>
  <div id="header">
    <div id="title">
      <div id="logoBadge">✈️</div>
      <div>
        <h1>TripLog</h1>
        <p>우리의 여행 기록</p>
      </div>
    </div>
    <div id="userChip" style="display:none">
      <div id="chipName">GUEST</div>
      <span class="badge badgeRank" id="chipRank">칭호: -</span>
      <span class="badge badgePhoto" id="chipPhoto" style="display:none">추억전달자</span>
    </div>
  </div>

  <!-- 출국 준비 -->
  <section id="screen-preflight" class="active" aria-label="출국 준비">
    <div id="prewrap">
      <div class="boarding">
        <div class="bp-top"><div>BOARDING PASS</div><div style="font-size:12px;opacity:.9">TripLog Air</div></div>
        <div class="bp-body">
          <div class="bp-field">
            <div class="bp-label">From</div>
            <div id="bp-from">ICN · 인천국제공항</div>
          </div>
          <div class="bp-field">
            <div class="bp-label">To (나라 또는 공항명/코드)</div>
            <input id="countryInput" class="bp-input" list="countryList" placeholder="예: 일본 / 오사카 간사이 / KIX">
            <datalist id="countryList"></datalist>
          </div>
          <div class="bp-field">
            <div class="bp-label">Region (지역)</div>
            <input id="regionInput" class="bp-input" placeholder="예: 오사카, 파리, 다낭">
          </div>
          <div class="bp-field">
            <div class="bp-label">Date · Time</div>
            <div id="bp-dt"></div>
          </div>
          <div class="bp-row" style="font-size:12px;opacity:.75">공항명을 직접 쓰거나 코드(KIX 등)를 써도 비행합니다.</div>
        </div>
      </div>

      <div class="passport">
        <div class="badge">REPUBLIC OF KOREA</div>
        <h3>대한민국 여권</h3>
        <div class="nameBox">
          <label>여권 영문명 (Passenger Name)</label>
          <input id="passengerName" placeholder="예: EUNCHAN KIM" />
        </div>
        <div style="margin-top:12px;font-size:12px;opacity:.85">
          이름을 입력하면 그 이름의 프로필이 활성화됩니다. (칭호·비행/사진 기록 유지)
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:center;padding:10px">
      <button id="departBtn" class="btn btnPrimary">✈️ 출국</button>
    </div>
  </section>

  <!-- 지도 화면 -->
  <section id="screen-map" aria-label="여행 지도">
    <div id="controls">
      <div class="ticket">
        🌍 <input id="countryInput2" type="text" placeholder="나라/공항명/코드 입력" list="countryList">
        <button class="btn" id="btnFly">✈️ 출발</button>
      </div>
      <div class="ticket">
        🗺️ <input id="regionInput2" type="text" placeholder="지역 입력 (예: 오사카, 파리, 다낭)">
        <button class="btn" id="btnDrive">🚕 이동</button>
      </div>
    </div>
    <div id="map"></div>

    <div id="memoryList" aria-live="polite">
      <h3>📸 저장된 추억 (누구나 열람 가능)</h3>
      <div id="memWrap"></div>
    </div>

    <div id="quickActions">
      <div class="quickCard">
        <button class="btnGhost" id="qaHint">📍 장소를 탭해서 추억 저장</button>
        <button class="btnWarn"  id="qaReturn">🇰🇷 귀국</button>
      </div>
    </div>
  </section>

  <!-- 공항 선택 모달 -->
  <div class="modal" id="airportModal">
    <div class="modalCard">
      <h3>도착 공항 선택</h3>
      <div id="airportOptions"></div>
      <div class="modalActions">
        <button class="btn" id="airportCancel">취소</button>
        <button class="btn btnPrimary" id="airportOk">비행 시작</button>
      </div>
    </div>
  </div>

  <!-- 추억 저장 모달 (장소 자동 라벨 추가) -->
  <div class="modal" id="memoryModal">
    <div class="modalCard">
      <h3>추억 저장</h3>
      <div style="font-size:12px;opacity:.75;margin-bottom:6px">지도에서 클릭/탭한 위치로 저장됩니다.</div>

      <label style="font-size:12px;opacity:.8">📍 장소 이름 (자동):</label>
      <input type="text" id="placeName" placeholder="예: 도쿄 타워" style="width:100%;margin:6px 0 10px">

      <input type="text" id="memoryTitle" placeholder="제목 (선택)" style="width:100%;margin:8px 0;">
      <textarea id="memoryText" rows="4" style="width:100%;margin:8px 0;" placeholder="사진 설명/메모를 남겨보세요"></textarea>
      <input type="file" id="memoryImage" accept="image/*" style="margin:8px 0;">
      <div style="font-size:12px;opacity:.7;margin-top:2px">작성자: <span id="authorPreview"></span></div>
      <div class="modalActions">
        <button class="btn" id="memCancel">닫기</button>
        <button class="btn btnPrimary" id="memSave">저장</button>
      </div>
    </div>
  </div>

  <!-- 갤러리(슬라이드) 모달 -->
  <div class="modal" id="galleryModal">
    <div class="modalCard">
      <div class="galleryHead">
        <div class="galleryTitle" id="galPlace">이 장소의 추억</div>
        <button class="btn" id="galClose">닫기</button>
      </div>
      <div class="galleryWrap" id="galWrap">
        <div class="galleryStage" id="galStage"></div>
      </div>
      <div class="galleryNav">
        <button class="btn" id="galPrev">◀ 이전</button>
        <button class="btn" id="galNext">다음 ▶</button>
      </div>
      <div class="galleryMeta">
        <div id="galCaption" style="white-space:pre-wrap"></div>
        <div class="by" id="galBy"></div>
      </div>
    </div>
  </div>

  <!-- 업적 모달 -->
  <div class="modal" id="achvModal">
    <div class="modalCard" style="text-align:center">
      <div style="font-size:22px;font-weight:800;color:#0e6eb8">조건 달성! 칭호 획득</div>
      <div id="achvTitle">—</div>
      <div id="achvBadge">—</div>
      <div class="modalActions" style="justify-content:center;margin-top:10px">
        <button class="btn btnPrimary" id="achvOk">확인</button>
      </div>
    </div>
  </div>

  <!-- 귀국 도착 모달 -->
  <div class="modal" id="returnModal">
    <div class="modalCard" style="text-align:center">
      <h3>🇰🇷 한국 도착</h3>
      <div style="margin-top:4px">여행을 종료하시겠어요, 아니면 계속하시겠어요?</div>
      <div class="modalActions" style="justify-content:center;margin-top:10px">
        <button class="btn" id="retContinue">계속하기 (티켓만)</button>
        <button class="btn btnPrimary" id="retEnd">여행 종료</button>
      </div>
    </div>
  </div>

<script>
/* ========= 전역 ========= */
let map, geocoder, planeMarker, carMarker, currentAirportLatLng=null, clickLatLng=null;
const memoryLayer = L.layerGroup(); const pathsLayer = L.layerGroup();
const ICN = {code:"ICN",name:"인천국제공항",lat:37.4602,lng:126.4407};
const toRad = d=>d*Math.PI/180, toDeg = r=>r*180/Math.PI;
const easeInOut = t => t<.5 ? 2*t*t : -1+(4-2*t)*t;
function nowKR(){const d=new Date();return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
document.getElementById('bp-dt').textContent = nowKR();
function bearing(a,b){
  const φ1=toRad(a.lat), φ2=toRad(b.lat), Δλ=toRad(b.lng-a.lng);
  const y=Math.sin(Δλ)*Math.cos(φ2), x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}
function setRotation(marker,deg){const el=marker?._icon?.querySelector('.icon-rot'); if(el){el.style.transform=`rotate(${deg}deg)`;}}

/* 탑뷰 아이콘 */
function makePlaneIcon(){
  const svg = `<svg width="40" height="40" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
    <g fill="#0e6eb8">
      <rect x="36" y="10" width="8" height="42" rx="3"></rect>
      <polygon points="40,4 34,12 46,12" />
      <polygon points="18,34 62,34 70,40 10,40" />
      <polygon points="30,52 50,52 46,66 34,66" />
      <rect x="37" y="66" width="6" height="8" rx="2"></rect>
    </g></svg>`;
  return L.divIcon({className:"", html:`<span class="icon-rot">${svg}</span>`, iconSize:[40,40], iconAnchor:[20,20]});
}
function makeTaxiIcon(){
  const svg = `<svg width="40" height="40" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
    <g>
      <circle cx="18" cy="20" r="6" fill="#333"/><circle cx="62" cy="20" r="6" fill="#333"/>
      <circle cx="18" cy="60" r="6" fill="#333"/><circle cx="62" cy="60" r="6" fill="#333"/>
      <rect x="18" y="14" width="44" height="52" rx="12" fill="#ffd21f" stroke="#caa300" stroke-width="2"/>
      <rect x="26" y="20" width="28" height="12" rx="4" fill="#fff"/>
      <rect x="22" y="38" width="36" height="8" fill="#000"/>
      <rect x="26" y="38" width="6" height="8" fill="#ffd21f"/><rect x="38" y="38" width="6" height="8" fill="#ffd21f"/><rect x="50" y="38" width="6" height="8" fill="#ffd21f"/>
    </g></svg>`;
  return L.divIcon({className:"", html:`<span class="icon-rot">${svg}</span>`, iconSize:[40,40], iconAnchor:[20,20]});
}

/* 공항 DB (OECD + 동남아 + 러시아 + 다공항) */
const airports = {
  "대한민국":[ICN],
  "일본":[
    {code:"NRT",name:"도쿄 나리타",lat:35.7719,lng:140.3929},
    {code:"HND",name:"도쿄 하네다",lat:35.5494,lng:139.7798},
    {code:"KIX",name:"오사카 간사이",lat:34.4347,lng:135.2442},
    {code:"FUK",name:"후쿠오카",lat:33.5859,lng:130.4500},
    {code:"CTS",name:"신치토세(삿포로)",lat:42.7752,lng:141.6923},
    {code:"OKA",name:"나하(오키나와)",lat:26.2068,lng:127.6469}
  ],
  "베트남":[
    {code:"HAN",name:"하노이 노이바이",lat:21.2210,lng:105.8072},
    {code:"SGN",name:"호찌민 떤선녓",lat:10.8188,lng:106.6519},
    {code:"DAD",name:"다낭",lat:16.0439,lng:108.1994},
    {code:"CXR",name:"나트랑 깜라인",lat:11.9981,lng:109.2194},
    {code:"PQC",name:"푸꾸옥",lat:10.1698,lng:103.9931},
    {code:"HUI",name:"후에",lat:16.4015,lng:107.703}
  ],
  "중국":[
    {code:"PEK",name:"베이징 수도",lat:40.0799,lng:116.6031},
    {code:"PKX",name:"베이징 다싱",lat:39.5099,lng:116.4108},
    {code:"PVG",name:"상하이 푸둥",lat:31.1443,lng:121.8083},
    {code:"SHA",name:"상하이 훙차오",lat:31.1979,lng:121.3363},
    {code:"CAN",name:"광저우 바이윈",lat:23.3924,lng:113.2988},
    {code:"SZX",name:"선전 바오안",lat:22.6393,lng:113.8107},
    {code:"CTU",name:"청두 솽류",lat:30.5785,lng:103.9471},
    {code:"HGH",name:"항저우 샤오산",lat:30.2362,lng:120.4324},
    {code:"XMN",name:"샤먼 가오치",lat:24.5440,lng:118.1278}
  ],
  "미국":[{code:"JFK",name:"뉴욕 JFK",lat:40.6413,lng:-73.7781}],
  "캐나다":[{code:"YYZ",name:"토론토 피어슨",lat:43.6777,lng:-79.6248}],
  "멕시코":[{code:"MEX",name:"멕시코시티",lat:19.4361,lng:-99.0719}],
  "영국":[{code:"LHR",name:"런던 히드로",lat:51.47,lng:-0.4543}],
  "프랑스":[{code:"CDG",name:"파리 샤를드골",lat:49.0097,lng:2.5479}],
  "독일":[{code:"FRA",name:"프랑크푸르트",lat:50.0379,lng:8.5622}],
  "이탈리아":[{code:"FCO",name:"로마 피우미치노",lat:41.8003,lng:12.2389}],
  "스페인":[{code:"MAD",name:"마드리드 바라하스",lat:40.4983,lng:-3.5676}],
  "네덜란드":[{code:"AMS",name:"스키폴",lat:52.3105,lng:4.7683}],
  "스위스":[{code:"ZRH",name:"취리히",lat:47.4581,lng:8.5555}],
  "오스트리아":[{code:"VIE",name:"비엔나",lat:48.1103,lng:16.5697}],
  "덴마크":[{code:"CPH",name:"코펜하겐",lat:55.6180,lng:12.6508}],
  "노르웨이":[{code:"OSL",name:"오슬로",lat:60.1976,lng:11.1004}],
  "스웨덴":[{code:"ARN",name:"알란다",lat:59.6498,lng:17.9238}],
  "핀란드":[{code:"HEL",name:"헬싱키",lat:60.3172,lng:24.9633}],
  "그리스":[{code:"ATH",name:"아테네",lat:37.9364,lng:23.9475}],
  "터키":[{code:"IST",name:"이스탄불",lat:41.2753,lng:28.7519}],
  "싱가포르":[{code:"SIN",name:"창이",lat:1.3644,lng:103.9915}],
  "말레이시아":[{code:"KUL",name:"쿠알라룸푸르",lat:2.7456,lng:101.709}],
  "인도네시아":[{code:"CGK",name:"수카르노-하타",lat:-6.1256,lng:106.6559}],
  "태국":[{code:"BKK",name:"수완나품",lat:13.69,lng:100.7501}],
  "필리핀":[{code:"MNL",name:"마닐라",lat:14.5086,lng:121.0198}],
  "러시아":[{code:"SVO",name:"모스크바 셰레메티예보",lat:55.9726,lng:37.4146}],
  "호주":[{code:"SYD",name:"시드니",lat:-33.9399,lng:151.1753}],
  "뉴질랜드":[{code:"AKL",name:"오클랜드",lat:-37.0082,lng:174.7850}]
};
let lastCountryName = "";
(function fillCountries(){
  const dl=document.getElementById('countryList');
  Object.keys(airports).forEach(n=>{const o=document.createElement('option');o.value=n;dl.appendChild(o);});
})();
const airportByNameOrCode = {};
Object.entries(airports).forEach(([country, list])=>{
  list.forEach(ap=>{
    airportByNameOrCode[ap.code.toLowerCase()] = ap;
    airportByNameOrCode[ap.name.toLowerCase()] = ap;
  });
});

/* 멀티 유저 + 칭호 */
const USER_KEY='triplog_users_v1';
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USER_KEY)||'{}'); }catch(e){ return {}; } }
function saveUsers(obj){ localStorage.setItem(USER_KEY, JSON.stringify(obj)); }
function ensureUser(name){ const users=loadUsers(); if(!users[name]) users[name]={ flights:0, photos:0, rankIdx:0 }; saveUsers(users); return users[name]; }
function setActiveUser(name){ window.TRIPLOG_USER = name; ensureUser(name); updateUserChip(); }
function getActiveUser(){ const users=loadUsers(); return users[window.TRIPLOG_USER] || {flights:0,photos:0,rankIdx:0}; }
function updateUser(obj){ const users=loadUsers(); users[window.TRIPLOG_USER]=obj; saveUsers(users); }
const RANKS = ["초보 여행가","루키 여행가","아마추어 여행가","프로 여행가","엘리트 여행가","트래블 마스터"];
function rankByFlights(f){ const idx = Math.min(5, Math.floor(f/30)); return {idx, name:RANKS[idx]}; }
function maybeAwardRank(oldFlights,newFlights){ const oldR=rankByFlights(oldFlights), nowR=rankByFlights(newFlights); if(nowR.idx>oldR.idx){ showAchievement(`비행 ${newFlights}회 달성!`, nowR.name); } }
function updatePhotoChampion(){ const users=loadUsers(); let topName=null, topCount=-1; Object.entries(users).forEach(([n,u])=>{ if(n==='_photoChampion') return; if(u.photos>topCount){ topCount=u.photos; topName=n; } }); const prev = users._photoChampion || null; users._photoChampion = topName || null; saveUsers(users); if(topName && topName===window.TRIPLOG_USER && prev!==topName){ showAchievement("사진 최다 등록자!", "추억전달자"); } }
function isPhotoChampion(name){ const users=loadUsers(); return users._photoChampion && users._photoChampion===name; }
function updateUserChip(){ const chip=document.getElementById('userChip'); const name=window.TRIPLOG_USER||'GUEST'; const u=getActiveUser(); const r=rankByFlights(u.flights); chip.style.display='flex'; document.getElementById('chipName').textContent = name; document.getElementById('chipRank').textContent = `칭호: ${r.name}`; document.getElementById('chipPhoto').style.display = isPhotoChampion(name)?'inline-block':'none'; }
function showAchievement(title,badge){ document.getElementById('achvTitle').textContent = title; document.getElementById('achvBadge').textContent = badge; openModal('achvModal'); }
document.getElementById('achvOk').onclick=()=>closeModal('achvModal');

/* 출국 */
document.getElementById('departBtn').addEventListener('click', ()=>{
  const name=document.getElementById('passengerName').value.trim();
  const dest=document.getElementById('countryInput').value.trim();
  const region=document.getElementById('regionInput').value.trim();
  if(!name){alert('여권 이름을 입력해주세요.');return;}
  if(!dest){alert('나라/공항을 입력해주세요.');return;}
  setActiveUser(name); document.getElementById('authorPreview').textContent = name;
  document.getElementById('screen-preflight').classList.remove('active');
  document.getElementById('screen-map').classList.add('active');
  setTimeout(initMapIfNeeded,0); setTimeout(()=>map.invalidateSize(),250);
  document.getElementById('countryInput2').value = dest;
  document.getElementById('regionInput2').value   = region;
  flyToDestination(dest, region);
});

/* 지도 초기화 */
function initMapIfNeeded(){
  if(map) return;
  map = L.map('map', { zoomControl:true }).setView([37.5665,126.9780], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  geocoder = L.Control.Geocoder.nominatim();
  L.Control.geocoder({ placeholder: '보조 검색(장소명)' }).addTo(map);
  memoryLayer.addTo(map); pathsLayer.addTo(map);

  // 지도 클릭 → 역지오코딩 후 모달
  map.on('click', async (e)=>{
    clickLatLng=e.latlng;
    document.getElementById('authorPreview').textContent = window.TRIPLOG_USER || '익명';
    await fillPlaceAuto(clickLatLng.lat, clickLatLng.lng);
    openModal('memoryModal');
  });

  document.getElementById('btnFly').onclick = ()=> flyToDestination(document.getElementById('countryInput2').value.trim());
  document.getElementById('btnDrive').onclick = ()=> driveToRegion(document.getElementById('regionInput2').value.trim());

  document.getElementById('memCancel').onclick = ()=> closeModal('memoryModal');
  document.getElementById('memSave').onclick = saveMemory;

  document.getElementById('qaHint').onclick = ()=> alert('지도를 움직여 장소를 고른 뒤, 지점을 탭/클릭하면 추억 저장 창이 열립니다.');
  document.getElementById('qaReturn').onclick = returnHome;

  document.getElementById('galPrev').onclick = ()=> galleryStep(-1);
  document.getElementById('galNext').onclick = ()=> galleryStep(+1);
  document.getElementById('galClose').onclick = ()=> closeModal('galleryModal');

  renderMemories();
}

/* 공항 선택 모달 */
const airportModal = document.getElementById('airportModal');
const airportOptions = document.getElementById('airportOptions');
document.getElementById('airportCancel').onclick = ()=> closeModal('airportModal');
document.getElementById('airportOk').onclick = ()=>{
  const idx = Number(document.querySelector('input[name="apSel"]:checked')?.value ?? 0);
  closeModal('airportModal');
  const ap = _pendingAirports[idx];
  doFly(ICN, ap);
};
let _pendingAirports = [];
function showAirportChoice(list){
  airportOptions.innerHTML = list.map((ap,i)=>`
    <label style="display:flex;gap:8px;align-items:center;margin:6px 0;">
      <input type="radio" name="apSel" value="${i}" ${i===0?'checked':''}/>
      <div><strong>${ap.name}</strong><div style="font-size:12px;opacity:.7">${ap.code} · ${ap.lat.toFixed(3)}, ${ap.lng.toFixed(3)}</div></div>
    </label>`).join('');
  _pendingAirports = list;
  openModal('airportModal');
}

/* 지오코딩 */
async function geocode(query){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&accept-language=ko&q=${encodeURIComponent(query)}`;
  const res = await fetch(url,{headers:{'Accept-Language':'ko'}});
  if(!res.ok) return null;
  const arr = await res.json();
  if(!arr || arr.length===0) return null;
  return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), display: arr[0].display_name };
}
/* 역지오코딩 → 장소 자동 라벨 */
async function reverseGeocode(lat,lng){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&accept-language=ko&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`;
  const res = await fetch(url, {headers:{'Accept-Language':'ko'}});
  if(!res.ok) return null;
  const data = await res.json();
  // 우선순위: landmark/attraction/building/amenity → road+house_number → suburb/city → country
  const a = data.address || {};
  return data.name
      || a.tourism
      || a.attraction
      || a.amenity
      || a.building
      || a.shop
      || a.leisure
      || a.road && (a.house_number ? `${a.road} ${a.house_number}` : a.road)
      || a.suburb
      || a.city
      || a.town
      || a.village
      || data.display_name
      || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}
async function fillPlaceAuto(lat,lng){
  const name = await reverseGeocode(lat,lng);
  const input = document.getElementById('placeName');
  input.value = name || '';
  // 제목이 비어있으면 장소 이름으로 기본 채우기
  const titleEl = document.getElementById('memoryTitle');
  if(!titleEl.value) titleEl.value = name || '';
}

/* 목적지 판단 → 비행 */
async function flyToDestination(input, regionAfter){
  if(!input){alert('나라/공항을 입력해주세요.');return;}
  const key = input.trim().toLowerCase();
  if(airportByNameOrCode[key]){
    lastCountryName = findCountryByAirport(airportByNameOrCode[key]);
    doFly(ICN, airportByNameOrCode[key], regionAfter);
    return;
  }
  await flyToCountry(input, regionAfter);
}
function findCountryByAirport(ap){
  for(const [c, list] of Object.entries(airports)){
    if(list.some(a=>a.code===ap.code)) return c;
  }
  return '';
}

/* 나라 비행 */
async function flyToCountry(country, regionAfter){
  if(!country){alert('나라를 입력해주세요.');return;}
  lastCountryName = country;
  const list = airports[country] || [];
  if(list.length > 1){ showAirportChoice(list); return; }
  if(list.length === 1){ doFly(ICN, list[0], regionAfter); return; }
  const c = await geocode(country);
  if(!c){ alert('해당 나라를 찾을 수 없어요. 다른 이름으로 시도해보세요.'); return; }
  const pseudoAp = { code:"CTR", name:`${country} 중심`, lat:c.lat, lng:c.lng };
  doFly(ICN, pseudoAp, regionAfter);
}

/* 비행(15초) */
function doFly(fromAp, toAp, regionAfter){
  currentAirportLatLng = null;
  pathsLayer.clearLayers();
  const start = L.latLng(fromAp.lat, fromAp.lng);
  const end   = L.latLng(toAp.lat, toAp.lng);
  L.polyline([start, end], {color:'#0e6eb8', weight:2, opacity:.6, dashArray:'6 8'}).addTo(pathsLayer);
  if(planeMarker) map.removeLayer(planeMarker);
  planeMarker = L.marker(start, { icon: makePlaneIcon(), interactive:false }).addTo(map);
  map.flyTo(start, 5, {duration:1.2});
  const dur = 15000; const t0 = performance.now(); let prev = start;
  (function step(ts){
    const p = Math.min(1, (ts - t0)/dur); const t = easeInOut(p);
    const lat = start.lat + (end.lat - start.lat) * t; const lng = start.lng + (end.lng - start.lng) * t;
    const now = L.latLng(lat,lng); planeMarker.setLatLng(now);
    const brg = bearing(prev, now); setRotation(planeMarker, brg); prev = now;
    if(p<1){ requestAnimationFrame(step); }
    else{
      currentAirportLatLng = end;
      setRotation(planeMarker, bearing(now, L.latLng(now.lat, now.lng+0.001)));
      map.flyTo(end, 6.5, {duration:2});
      const u=getActiveUser(); const old=u.flights; u.flights += 1; updateUser(u); maybeAwardRank(old,u.flights); updateUserChip();
      if(regionAfter) setTimeout(()=>driveToRegion(regionAfter), 1200);
    }
  })(t0);
}

/* 공항 → 지역 택시 */
async function driveToRegion(region){
  if(!region){alert('지역을 입력해주세요.');return;}
  if(!currentAirportLatLng){alert('먼저 나라/공항으로 비행해 착륙해야 해요.');return;}
  const q = lastCountryName ? `${region} ${lastCountryName}` : region;
  const dst = await geocode(q);
  if(!dst){ alert('해당 지역을 찾을 수 없어요. 다른 표기로 시도해보세요.'); return; }
  const start = L.latLng(currentAirportLatLng.lat, currentAirportLatLng.lng);
  const end   = L.latLng(dst.lat, dst.lng);
  L.polyline([start, end], {color:'#ffb703', weight:2, opacity:.9, dashArray:'2 6'}).addTo(pathsLayer);
  if(carMarker) map.removeLayer(carMarker);
  carMarker = L.marker(start, { icon: makeTaxiIcon(), interactive:false }).addTo(map);
  map.flyTo(start, 8, {duration:1.0});
  const distance = start.distanceTo(end); const dur = Math.min(16000, Math.max(6000, distance/30));
  const t0 = performance.now(); let prev = start;
  (function step(ts){
    const p = Math.min(1, (ts - t0)/dur); const t = easeInOut(p);
    const lat = start.lat + (end.lat - start.lat) * t; const lng = start.lng + (end.lng - start.lng) * t;
    const now = L.latLng(lat,lng); carMarker.setLatLng(now);
    const brg = bearing(prev, now); setRotation(carMarker, brg); prev = now;
    if(p<1){ requestAnimationFrame(step); }
    else{
      map.flyTo(end, 13.5, {duration:1.6});
      L.circleMarker(end, {radius:6,color:'#ff8800',fillColor:'#ff8800',fillOpacity:.85}).addTo(pathsLayer)
       .bindTooltip('여기에서 지도를 손가락으로 움직여 주변을 보고,\n맘에 드는 지점을 탭/클릭해서 추억을 저장하세요.', {permanent:false, direction:'top'});
    }
  })(t0);
}

/* 귀국 */
function returnHome(){
  const here = carMarker?.getLatLng() || planeMarker?.getLatLng() || (currentAirportLatLng ? L.latLng(currentAirportLatLng.lat,currentAirportLatLng.lng) : L.latLng(ICN.lat,ICN.lng));
  const start = here; const end = L.latLng(ICN.lat, ICN.lng);
  if(planeMarker) map.removeLayer(planeMarker);
  planeMarker = L.marker(start, { icon: makePlaneIcon(), interactive:false }).addTo(map);
  pathsLayer.clearLayers();
  L.polyline([start, end], {color:'#0e6eb8', weight:2, opacity:.6, dashArray:'6 8'}).addTo(pathsLayer);
  const dur = 15000; const t0 = performance.now(); let prev=start;
  (function step(ts){
    const p = Math.min(1, (ts - t0)/dur); const t = easeInOut(p);
    const lat = start.lat + (end.lat - start.lat) * t; const lng = start.lng + (end.lng - start.lng) * t;
    const now = L.latLng(lat,lng); planeMarker.setLatLng(now);
    setRotation(planeMarker, bearing(prev, now)); prev=now;
    if(p<1){ requestAnimationFrame(step); }
    else{
      map.flyTo(end, 7, {duration:1.6});
      currentAirportLatLng = {lat:end.lat,lng:end.lng};
      const u=getActiveUser(); const old=u.flights; u.flights += 1; updateUser(u); maybeAwardRank(old,u.flights); updateUserChip();
      openModal('returnModal');
    }
  })(t0);
}
document.getElementById('retEnd').onclick = ()=>{
  closeModal('returnModal'); pathsLayer.clearLayers();
  if(planeMarker) { map.removeLayer(planeMarker); planeMarker=null; }
  if(carMarker) { map.removeLayer(carMarker); carMarker=null; }
  document.getElementById('screen-map').classList.remove('active');
  document.getElementById('screen-preflight').classList.add('active');
};
document.getElementById('retContinue').onclick = ()=>{
  closeModal('returnModal');
  document.getElementById('screen-preflight').classList.remove('active');
  document.getElementById('screen-map').classList.add('active');
  document.getElementById('countryInput2').focus();
};

/* 모달 */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

/* 추억 저장소 */
const STORE_KEY = 'triplog_memories_v4'; // v4: 장소 자동 라벨 추가
function loadMemories(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch(e){ return []; } }
function saveMemories(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }
function nfix(v){ return Math.round(v*1e5)/1e5; } // ~1m 해상도
function locKey(lat,lng){ return `${nfix(lat)},${nfix(lng)}`; }

function addMemoryMarkerForPlace(key, arr){
  const [lat,lng] = key.split(',').map(Number);
  const label = arr[0]?.place || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  const mk = L.marker([lat,lng]).addTo(memoryLayer);
  mk.bindTooltip(label, {permanent:false, direction:'top'});
  mk.on('click', ()=> openGalleryAt(key));
}

function renderMemories(){
  memoryLayer.clearLayers();
  const list = loadMemories();
  const byPlace = {};
  list.forEach(m=>{
    const key = locKey(m.lat, m.lng);
    if(!byPlace[key]) byPlace[key]=[];
    byPlace[key].push(m);
  });

  Object.entries(byPlace).forEach(([key,arr])=> addMemoryMarkerForPlace(key, arr));

  const wrap = document.getElementById('memWrap'); wrap.innerHTML='';
  const sorted = [...list].reverse();
  sorted.forEach((m)=>{
    const row = document.createElement('div');
    row.className='mem';
    row.innerHTML = `<span>📍</span>
      <div>
        <div style="font-weight:600">${m.place || m.title || '무제'}</div>
        <div style="font-size:12px;opacity:.7">${m.time} · ${m.author||'익명'}</div>
      </div>`;
    row.onclick = ()=>{ openGalleryAt(locKey(m.lat,m.lng)); };
    wrap.appendChild(row);
  });
}

async function saveMemory(){
  if(!clickLatLng){ closeModal('memoryModal'); return;}
  const place = document.getElementById('placeName').value.trim();
  const title = document.getElementById('memoryTitle').value.trim();
  const text  = document.getElementById('memoryText').value.trim();
  const file  = document.getElementById('memoryImage').files[0];
  let img64 = '';
  if(file){ img64 = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

  const author = window.TRIPLOG_USER || '익명';
  const m = { lat:nfix(clickLatLng.lat), lng:nfix(clickLatLng.lng), place, title, text, img:img64, time:nowKR(), author };
  const list = loadMemories(); list.push(m); saveMemories(list);

  const u=getActiveUser(); u.photos += 1; updateUser(u); updatePhotoChampion(); updateUserChip();

  document.getElementById('placeName').value='';
  document.getElementById('memoryTitle').value=''; document.getElementById('memoryText').value=''; document.getElementById('memoryImage').value='';
  closeModal('memoryModal'); renderMemories();
}

/* 갤러리(슬라이드) — 버튼 + 스와이프 */
let galList=[], galIndex=0, galKey='';
const galStage = ()=>document.getElementById('galStage');
function openGalleryAt(key){
  const [lat,lng] = key.split(',').map(Number);
  const list = loadMemories().filter(m=> locKey(m.lat,m.lng)===key);
  if(list.length===0) return;
  galList = list; galIndex = 0; galKey = key;

  const stage = galStage(); stage.innerHTML = '';
  list.forEach(m=>{
    const div = document.createElement('div');
    div.className='galleryItem';
    if(m.img){
      const img = document.createElement('img'); img.src=m.img; img.alt=m.title||m.place||'사진';
      div.appendChild(img);
    }else{
      const ph = document.createElement('div');
      ph.style.color='#fff'; ph.style.padding='28px'; ph.textContent='(사진 없음)';
      div.appendChild(ph);
    }
    stage.appendChild(div);
  });

  const placeLabel = list[0]?.place || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  document.getElementById('galPlace').textContent = `${placeLabel} · 총 ${list.length}개`;
  applyGalleryIndex(true);
  setupSwipe(document.getElementById('galWrap'));
  openModal('galleryModal');
}
function applyGalleryIndex(immediate=false){
  const stage = galStage();
  const x = -galIndex*100;
  if(immediate) stage.style.transition='none'; else stage.style.transition='transform .35s ease';
  stage.style.transform = `translateX(${x}%)`;

  const m = galList[galIndex];
  const titlePart = m?.title ? `${m.title} · ` : '';
  document.getElementById('galCaption').textContent = m?.text || '';
  document.getElementById('galBy').textContent = `${titlePart}${m?.author||'익명'} · ${m?.time||''}`;
}
function galleryStep(dir){ if(!galList.length) return; galIndex = (galIndex + dir + galList.length) % galList.length; applyGalleryIndex(); }
function setupSwipe(el){
  let sx=0, sy=0, dx=0, dy=0, touching=false;
  el.ontouchstart = (e)=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; dx=0; dy=0; touching=true; };
  el.ontouchmove = (e)=>{ if(!touching) return; const t=e.touches[0]; dx=t.clientX-sx; dy=t.clientY-sy; };
  el.ontouchend = ()=>{ touching=false; if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)){ if(dx<0) galleryStep(+1); else galleryStep(-1); } };
}

/* 보조 */
function invalidateSoon(){ setTimeout(()=>map && map.invalidateSize(), 300); }
document.getElementById('btnFly').addEventListener('click', ()=> invalidateSoon());
document.getElementById('btnDrive').addEventListener('click', ()=> invalidateSoon());
(function fillCountriesOnce(){ const dl=document.getElementById('countryList'); if(dl.childElementCount) return; Object.keys(airports).forEach(n=>{const o=document.createElement('option');o.value=n;dl.appendChild(o);}); })();
</script>
</body>
</html>
