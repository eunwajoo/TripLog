<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TripLog - 우리의 여행 기록</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f9ff; }
    #map { height: 100vh; display:none; }
    .ticket, .passport { border:2px solid #0a3d91; border-radius:10px; padding:20px; margin:10px; background:#fff; }
    #start-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
    #memoriesModal, #memoryViewModal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:400px; width:90%; }
    .slider { position:relative; }
    .slider img { max-width:100%; border-radius:10px; }
    .slider button { position:absolute; top:50%; transform:translateY(-50%); background:#0a3d91; color:#fff; border:none; padding:10px; cursor:pointer; }
    .slider button.prev { left:0; }
    .slider button.next { right:0; }
  </style>
</head>
<body>
<div id="start-screen">
  <div class="ticket">
    <h2>✈️ 항공권</h2>
    <label>도착 국가/공항 선택: <input type="text" id="destination"></label>
  </div>
  <div class="passport">
    <h2>🛂 여권</h2>
    <label>이름 입력: <input type="text" id="travelerName"></label>
  </div>
  <button id="departBtn">출국</button>
</div>
<div id="map"></div>

<!-- 추억 등록 모달 -->
<div id="memoriesModal">
  <div class="modal-content">
    <h3 id="placeLabel">추억 등록</h3>
    <input type="file" id="photoInput"><br><br>
    <textarea id="memoryText" placeholder="추억을 적어주세요"></textarea><br><br>
    <button id="saveMemory">저장</button>
    <button onclick="closeMemoryModal()">닫기</button>
  </div>
</div>

<!-- 추억 보기 모달 -->
<div id="memoryViewModal">
  <div class="modal-content">
    <h3 id="memoryPlace"></h3>
    <div class="slider">
      <button class="prev" onclick="prevSlide()">◀</button>
      <img id="memoryPhoto" src="">
      <button class="next" onclick="nextSlide()">▶</button>
    </div>
    <p id="memoryDesc"></p>
    <p id="memoryAuthor"></p>
    <button onclick="closeViewModal()">닫기</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map, travelerName="", currentPlace="", currentLatLng=null;
  let memories = JSON.parse(localStorage.getItem("memories")||"[]");
  let memoryIndex = 0, memoryList=[];

  document.getElementById("departBtn").onclick = () => {
    travelerName = document.getElementById("travelerName").value;
    if(!travelerName) { alert("이름을 입력하세요!"); return; }
    document.getElementById("start-screen").style.display="none";
    document.getElementById("map").style.display="block";
    initMap();
  };

  function initMap(){
    map = L.map("map").setView([37.5665,126.9780], 5); // 한국 서울 기본
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);
    renderMemories();
    map.on("click", e => {
      currentLatLng = e.latlng;
      currentPlace = `(${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)})`;
      document.getElementById("placeLabel").innerText = currentPlace;
      document.getElementById("memoriesModal").style.display="flex";
    });
  }

  function closeMemoryModal(){ document.getElementById("memoriesModal").style.display="none"; }
  function closeViewModal(){ document.getElementById("memoryViewModal").style.display="none"; }

  document.getElementById("saveMemory").onclick = () => {
    let file = document.getElementById("photoInput").files[0];
    let reader = new FileReader();
    reader.onload = function(e){
      let mem = {place:currentPlace, latlng:currentLatLng, photo:e.target.result, text:document.getElementById("memoryText").value, author:travelerName};
      memories.push(mem);
      localStorage.setItem("memories", JSON.stringify(memories));
      renderMemories();
      closeMemoryModal();
    };
    if(file){ reader.readAsDataURL(file); }
    else{
      let mem = {place:currentPlace, latlng:currentLatLng, photo:"", text:document.getElementById("memoryText").value, author:travelerName};
      memories.push(mem);
      localStorage.setItem("memories", JSON.stringify(memories));
      renderMemories();
      closeMemoryModal();
    }
  };

  function renderMemories(){
    if(!map) return;
    memories.forEach((mem,i)=>{
      let marker = L.marker(mem.latlng).addTo(map);
      marker.on("click", ()=>{ openViewModal(mem.place); });
    });
  }

  function openViewModal(place){
    memoryList = memories.filter(m=>m.place===place);
    memoryIndex=0;
    showSlide();
    document.getElementById("memoryViewModal").style.display="flex";
    document.getElementById("memoryPlace").innerText=place;
  }

  function showSlide(){
    let mem = memoryList[memoryIndex];
    document.getElementById("memoryPhoto").src = mem.photo;
    document.getElementById("memoryDesc").innerText = mem.text;
    document.getElementById("memoryAuthor").innerText = "작성자: "+mem.author;
  }
  function prevSlide(){ memoryIndex=(memoryIndex-1+memoryList.length)%memoryList.length; showSlide(); }
  function nextSlide(){ memoryIndex=(memoryIndex+1)%memoryList.length; showSlide(); }
</script>
</body>
</html>
